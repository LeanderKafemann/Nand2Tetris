name: Assemble

on:
  workflow_dispatch:
  push:
    paths:
      - '06/**'
      - '04/**'
      - '.github/workflows/assemble.yml'
      - '**/*.asm'
      - '**/autoAssemble.bool'

jobs:
  assemble:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read autoAssemble flags
        id: check
        run: |
          # Suche nach allen autoAssemble.bool Dateien (außer in .git)
          flags_found=false
          should_run=false
          while IFS= read -r -d '' file; do
            flags_found=true
            val=$(tr -d '[:space:]' < "$file" || echo "false")
            val=$(echo "$val" | tr '[:upper:]' '[:lower:]')
            echo "Found $file -> '$val'"
            if [ "$val" = "true" ]; then
              should_run=true
              break
            fi
          done < <(find . -path './.git' -prune -o -type f -name 'autoAssemble.bool' -print0)

          if [ "$flags_found" = "false" ]; then
            echo "No autoAssemble.bool files found; defaulting to false"
          fi

          if [ "$should_run" = "true" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Abort early if autoAssemble is not true
        if: steps.check.outputs.should_run != 'true'
        run: |
          echo "Kein autoAssemble.bool mit 'true' gefunden — Workflow bricht vor Assemblen ab."

      - name: Prepare output file in 04 (truncate/create)
        if: steps.check.outputs.should_run == 'true'
        run: |
          mkdir -p 04
          : > 04/autoAssembleOut.output
          echo "autoAssemble run started at $(date -u)" | tee -a 04/autoAssembleOut.output

      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run assembler on all .asm files (recursive) and log output
        if: steps.check.outputs.should_run == 'true'
        shell: bash -l {0}
        run: |
          found=false
          # Rekursiv alle .asm Dateien finden (außer .git) und für jede Datei
          while IFS= read -r -d '' asm; do
            found=true
            echo "====== Assembling: $asm ======" | tee -a 04/autoAssembleOut.output
            # Übergibt den Pfad der .asm Datei an 06/assembler_template.py und protokolliert stdout+stderr
            python3 06/assembler_template.py "$asm" 2>&1 | tee -a 04/autoAssembleOut.output
            status=${PIPESTATUS[0]}
            if [ $status -ne 0 ]; then
              echo "Assembler failed for $asm with exit code $status" | tee -a 04/autoAssembleOut.output
              # Fehler zum Abbruch weiterreichen (optional: entferne das exit, wenn du fortsetzen willst)
              exit $status
            else
              echo "Assembler succeeded for $asm" | tee -a 04/autoAssembleOut.output
            fi
          done < <(find . -path './.git' -prune -o -type f -name '*.asm' -print0)

          if [ "$found" = "false" ]; then
            echo "Keine .asm Dateien gefunden." | tee -a 04/autoAssembleOut.output
          fi

      - name: Final status
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "autoAssemble finished at $(date -u)" | tee -a 04/autoAssembleOut.output
